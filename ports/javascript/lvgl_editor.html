<!doctype html>
<!-- Updated for 6.0 -->
<html>
	<head>
		
		
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600"></script>
		<link rel="stylesheet" href="https://littlevgl.com/bootstrap/css/bootstrap.min.css"/>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.4/xterm.min.css" />
		<link rel="stylesheet" href="https://littlevgl.com/common.css"/>
		<title>LittlevGL/MicroPython Simulator</title>
		<style>
			* {
				font-size: normal;
			}
			html, body {
				width: 100%;
				height: 100%;
				min-width: 100%;
				min-height: 100%;
				margin: 0;
				padding: 0;
			}
			#mp_js_stdout {
				display: inline-block;
				vertical-align: top;
			}
			#editor {
				position: relative;
				width: 100%;
			}
			iframe {
				width: 0;
				height: 0;
				display: inline-block;
				position: absolute;
				top: 0;
				left: 0;
				border: none;
			}
			#canvas {
				border: 4px black solid;
				box-sizing: content-box;
				vertical-align: top;
				display: inline-block;
				flex: none;
				width: 480px;
				height: 320px;
 				min-width: 0;
			};
			a { white-space: nowrap; }
			.flex-container {
				display: flex;
				width: 100%;
				height: 100%;
				flex-direction: column;
			}
			.flex-container> div {
				flex: none;
			}
			#editor {
				flex: auto;
			}
			.display-objects {
				display: flex;
				flex-direction: row;
			}
			#mp_js_stdout {
				flex: 1 0 auto;
				height: 328px;
				background-color: black;
			}
			.ace_editor * {
				font-size: 12px;
				line-height: normal;
			}
		</style>
		<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
		<script src="https://littlevgl.com/bootstrap/js/bootstrap.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.4/ace.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.4/mode-python.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.4/xterm.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.4/addons/fit/fit.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.js" type="text/javascript" charset="utf-8"></script>
		<script src="query.js"></script>
	</head>
	<body>
		<div class="flex-container">
			<div style="display: inline-block; padding: 10px;" class="no-iframe">
			<h1>LittlevGL+MicroPython simulator</h1>
			<p>
			This is the JavaScript version of MicroPython, plus the LittlevGL bindings available at
			<a href="https://github.com/littlevgl/lv_binding_micropython">https://github.com/littlevgl/lv_binding_micropython</a>.
			<br>
			You can type your own Python code into the prompt in the usual way.
			<br>
			For examples, see the README for the MicroPython binding.
		
			<p>
			<input type="button" disabled="disabled" id="run-button" value="Run the script" onclick="runScript();"/>

			<span>
			Copy/paste script here:
			<input onClick="this.setSelectionRange(0, this.value.length)" id="script-compressed" oninput="input_change();"/>
			</span>


			</div>
			<div id="editor">print("Hello world")</div>
			<div class="display-objects">
				
				<canvas id="canvas" width="480" height="320" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>
				<div id="mp_js_stdout"></div>
			</div>
		</div>
		<iframe src="about:blank" id="emscripten-iframe"></iframe>
        
		<script>
			var editor, iframe;
			var script_passed = false;
			function beginAnimationLoop() {
				iframe.contentWindow.handle_pending();
				window.requestAnimationFrame(beginAnimationLoop);
			}
			// Ctrl+L is mandatory ! need xterm.js 3.14+
		    function xterm_helper(term, key) {
				function ESC(data) {
					return String.fromCharCode(27)+data
				}
				if ( key.charCodeAt(0)==12 ) {
					var cy = 0+term.buffer.cursorY
					if ( cy > 0) {
					if (cy <= term.rows) {
						term.write( ESC("[B") )
						term.write( ESC("[J") )
						term.write( ESC("[A") )
					}

					term.write( ESC("[A") )
					term.write( ESC("[K") )
					term.write( ESC("[1J"))

					for (var i=1;i<cy;i++) {
						term.write( ESC("[A") )
						term.write( ESC("[M") )
					}
					term.write( ESC("[M") )
					}
					return false
				}
				return true
		    }
			function forward_event(event) {
				if(iframe !== undefined && iframe !== null) {
					if(iframe.contentWindow !== null)
						iframe.contentWindow.document.dispatchEvent(new MouseEvent('mouseup'));
				}
			}
			
			document.onmouseup = forward_event;
			function input_change() {
				editor.session.setValue(LZString.decompressFromEncodedURIComponent($("#script-compressed").val()));
			}
			function editor_change() {
				var script_string = LZString.compressToEncodedURIComponent(editor.getValue());
				$("#script-compressed").val(script_string);
				/*
				var new_href = update_query_string(window.location.href, "script_direct", script_string);
				// Create a dummy element to parse the URI with
				window.history.replaceState({path:new_href}, document.title,new_href); */
			}
			function runScript() {
				var $this = $("#run-button");
				$this.prop("disabled", "disabled");
				term.write('\x1bc');
				

				const context = document.getElementById("canvas").getContext('2d');

				context.clearRect(0, 0, canvas.width, canvas.height);


				
				iframe.setAttribute("data-cscript", LZString.compressToEncodedURIComponent(editor.getValue()));

				clear_iframe(iframe);
				iframe.src = get_iframe_url() + "&timestamp=" + new Date().getTime();
				iframe.contentWindow.location.href = iframe.src;
				console.log("Iframe src: " + iframe.src);
			}
			function reenableButton() {
				$("#run-button").removeProp('disabled');
			}
			function get_iframe_url() {
				/* Assemble the URL */
				var num_url_chars = (window.location.href.indexOf('?'));
				var base_url = window.location.href.substr(0, (num_url_chars == -1) ? undefined : num_url_chars);
				var newPathname = base_url.substr(0, base_url.lastIndexOf('/'));
				newPathname += "/lvgl.html" + '?' + "env=dev";
				return newPathname;
			}
			function processScriptArg(url, lzstring){
				var script_passed_handler = function() {
					console.log("Script passed: " + script_passed);
					if(script_passed)
						runScript();
					else
						reenableButton();
					script_passed = false;
				};
				if(!lzstring) {
					// read text from URL location
					var request = new XMLHttpRequest();
					console.log("GET " + url);
					request.open('GET', url, true);
					request.send(null);
					request.onreadystatechange = function () {
						if (request.readyState === 4 && request.status === 200) {
						
							console.log(request.reponseText);
							if(request.responseText === undefined)
								return;
							editor.session.getUndoManager().reset();
							editor.session.setValue(request.responseText, -1);
							script_passed_handler();
						}
					}
				} else {
					// decompress LZString
					editor.session.setValue(LZString.decompressFromEncodedURIComponent(url));
					script_passed_handler();
				}
				
			}
			function getSearchArg(argname) {
				/* Run custom script if passed */
				var custom = undefined;
				try {
					custom = new URL(window.location.href).searchParams.get(argname);
				} catch (e) {
					console.log(e + ": URL seems to be unsupported");
				}
				return custom;
			}
			function clear_iframe(iframe) {
				iframe.contentWindow.document.open();
				iframe.contentWindow.document.write("");
				iframe.contentWindow.document.close();
			}
			$(window).load(function() {
			    editor = ace.edit("editor");
				editor.getSession().setUseWrapMode(true);
				editor.setAutoScrollEditorIntoView(true);
				var PythonMode = ace.require("ace/mode/python").Mode;
				editor.session.setMode(new PythonMode());
				iframe = document.getElementById("emscripten-iframe");
				iframe.src = "about:blank";
				iframe.contentWindow.location.href = iframe.src;
				clear_iframe(iframe);
				

				
				Terminal.applyAddon(fit);
				term = new Terminal({
					tabStopWidth : 8,
				        cursorBlink : true,
				        cursorStyle : 'block',
				        applicationCursor : true
				});
				mp_js_stdout = document.getElementById('mp_js_stdout');
			    mp_js_stdout.value = "";
				term.open(mp_js_stdout);
				term.fit();
				term.on('data', function(key, e) {
					if ( xterm_helper(term, key) ) {
						for(var i = 0; i < key.length; i++) {
							if(iframe.contentWindow !== null)
								iframe.contentWindow.mp_js_process_char(key.charCodeAt(i));
						}
					}
				});
				
				mp_js_stdout.addEventListener('print', function(e) {
					text = e.data;
					term.write(text);
				}, false);
				editor.getSession().on('change', editor_change);
				editor.resize();
				term.fit();
				var script = getSearchArg("script");
				var script_direct = getSearchArg("script_direct");
				if(script_direct !== undefined && script_direct !== null) {
					script_passed = true;
					processScriptArg(script_direct, true);
				} else if(script !== undefined && script !== null) {
					script_passed = true;
					processScriptArg(script);
				} else
					processScriptArg("https://raw.githubusercontent.com/littlevgl/lv_binding_micropython/dev-6.0/examples/advanced_demo.py");
			});
			$(window).resize(function() {
				editor.resize();
				term.fit();
			});
		</script>
	</body>
</html>
